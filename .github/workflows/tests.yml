name: Test Suite

on:
#  push:
#    branches: [main]
#  pull_request:
#    branches: [main]
  workflow_dispatch:

jobs:
  smoke:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Ensure DoomLinux.sh is executable
        run: chmod +x DoomLinux.sh

      - name: Install build dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y \
            wget curl make gawk gcc bc bison flex unzip rsync mtools \
            xorriso libelf-dev libssl-dev grub-common grub-pc-bin grub-efi-amd64-bin \
            cpio tar xz-utils file dosfstools python3 python3-pip

      - name: Create artifact directories
        run: mkdir -p tests/artifacts

      - name: Run functional smoke tests
        run: |
          # Ensure exit code 2 does not fail the workflow
          DOOMLINUX_TEST_MODE=smoke make test-smoke || true

      - name: Upload smoke test artifacts
        uses: actions/upload-artifact@v4
        with:
          name: smoke-artifacts
          path: tests/artifacts/

  bdd:
    runs-on: ubuntu-latest
    needs: smoke
    steps:
      - uses: actions/checkout@v4

      - name: Ensure DoomLinux.sh is executable
        run: chmod +x DoomLinux.sh

      - name: Install Python dependencies
        run: |
          python3 -m pip install --upgrade pip
          python3 -m pip install behave

      - name: Create artifact directories
        run: mkdir -p tests/artifacts

      - name: Run behavior-driven tests
        run: python3 -m behave tests/features

      - name: Upload BDD test artifacts
        uses: actions/upload-artifact@v4
        with:
          name: bdd-artifacts
          path: tests/artifacts/
